/* ZD */
YUI.add("iuploader",function(a){var b=['<div class="yui3-iuploader-container">','<div class="yui3-iuploader-dd">','<ul class="yui3-iuploader-list"></ul>','<div class="yui3-iuploader-fileselect">','<div class="yui3-iuploader-select"></div>',"<p>或者可以将图片拖拽到这里</p>","</div>","</div>",'<div class="yui3-iuploader-button">','<button type="button" class="yui3-button yui3-iuploader-upload">上传图片</button>','<button type="button" class="yui3-button yui3-iuploader-remove">移除图片</button>',"</div>","</div>"].join(""),c='<li id="{id}" data-name="{name}"><em>{name}</em><span>0%</span></li>';a.ImageUploader=a.Base.create("iuploader",a.Uploader,[],{initializer:function(){this.form=this.get("form"),this.action=this.form.getAttribute("action"),this.set("uploadURL",this.action),a.after(this.bindUploader,this,"render",this),this.renderUploader()},renderUploader:function(){this.container=a.Node.create(b),this.form.append(this.container),this.form.addClass("yui3-iuploader-form"),this.fileSelectNode=this.container.one(".yui3-iuploader-fileselect"),this.fileListNode=this.container.one(".yui3-iuploader-list"),this.uploadBtn=this.container.one(".yui3-iuploader-upload"),this.removeBtn=this.container.one(".yui3-iuploader-remove"),this.set("dragAndDropArea",this.container.one(".yui3-iuploader-dd")),this.render(this.container.one(".yui3-iuploader-select"))},bindUploader:function(){this.after("fileselect",this.afterFileSelect),this.on("uploadstart",this.onUploadStart),this.on("uploadprogress",this.onUploadProgress),this.on("alluploadscomplete",this.onAllUploadsComplete),this.uploadBtn.on("click",this.onUploadBtnClick,this),this.removeBtn.on("click",this.onRemoveBtnClick,this)},readFile:function(a,b,c){var d=new FileReader;d.onload=function(){b&&b.call(c||this,this.result)};try{d.readAsDataURL(a)}catch(e){}},afterFileSelect:function(b){var d=b.fileList,e=this.get("fileList");this.fileSelectNode.setStyle("width","30%"),e.length===d.length&&this.fileListNode.empty(),a.Array.each(d,function(b){var d=a.Node.create(a.Lang.sub(c,{id:b.get("id"),name:b.get("name")}));this.fileListNode.append(d),this.readFile(b.get("file"),function(a){d.prepend('<img src="'+a+'" />')})},this)},onUploadStart:function(){this.set("enabled",!1),this.uploadBtn.addClass("yui3-button-disabled"),this.removeBtn.addClass("yui3-button-disabled")},onUploadProgress:function(b){a.one("#"+b.file.get("id")+" span").setContent(b.percentLoaded+"%")},onAllUploadsComplete:function(){this.uploadBtn.removeClass("yui3-button-disabled"),this.removeBtn.removeClass("yui3-button-disabled"),this.set("enabled",!0),this.set("fileList",[])},onUploadBtnClick:function(){this.uploadBtn.hasClass("yui3-button-disabled")||(this.get("fileList").length>0?this.uploadAll():alert("请选择需要上传的图片！"))},onRemoveBtnClick:function(){var a=!0;this.removeBtn.hasClass("yui3-button-disabled")||(this.get("fileList").length>0&&(a=window.confirm("确定移除还未上传的图片吗？")),a&&(this.fileListNode.empty(),this.fileSelectNode.setStyle("width","100%"),this.set("fileList",[])))}},{ATTRS:{form:{setter:a.one},width:{value:"150px"},height:{value:"35px;"},simLimit:{value:5},withCredentials:{value:!1},multipleFiles:{value:!0},selectButtonLabel:{value:"选择图片"},reload:{value:!0}}}),a.on("domready",function(){a.all(".yui3-iuploader-form").each(function(b){b.iuploader=new a.ImageUploader({form:b})})})},"0.0.1",{requires:["base","uploader","iuploader-skin"]});