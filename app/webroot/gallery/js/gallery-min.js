/* ZD */
YUI.add("gallery",function(a){function b(a){for(var b,c=location.hash.substring(1),d=c.split("&"),e={};d.length;)b=d.shift().split("="),b[0]&&(e[b[0]]=b[1]||"");return a?e[a]||"":e}function c(a,c){var d,e=b(),f=[],g="";e[a]=c||0===c?c:"";for(d in e)e.hasOwnProperty(d)&&f.push(d+"="+e[d]);g+=f.join("&"),location.hash=g}a.Gallery={init:function(){this.id=!1,this.data={},this.initLoading(),this.initTip(),this.bindAlbums(),this.showSelected()},initGalleria:function(b){this.galleria=new a.Galleria({source:b,zIndex:1e4,visible:!1,render:!0}),this.galleria.on("select",function(a){c("imageid",a.id)}),this.galleria.after("visibleChange",function(a){a.newVal||(c("albumid",""),c("imageid",""))})},showSelected:function(){var c=b(),d=c.albumid,e=c.imageid;a.Array.some(a.all(".album-item").getDOMNodes(),function(a){return a.getAttribute("data-albumid")===d?(this.showAlbum(d,e),!0):void 0},this)},showGalleria:function(b,d){var e=!1;this.loading.setStyle("display","none"),a.Lang.isString(b)&&(b=this.data[b],e=!0),b&&b.images&&b.images.length?(e||(this.galleria?this.galleria.set("source",b):this.initGalleria(b)),this.galleria&&(this.galleria.show(),this.galleria.showImage(d))):(this.showTip("这个相册还没有图片哦~"),c("albumid",""),c("imageid",""))},showAlbum:function(a,b){return c("albumid",a),this.hideTip(),this.id&&a===this.id&&this.data[a]?(this.showGalleria(a,b),this):(this.loading.setStyle("display","block"),this.id=a,this.getAlbumData(a,function(c){c&&(this.data[a]=c),this.id===a&&this.showGalleria(c,b)}),this)},getAlbumData:function(b,d){var e=this;this.data[b]?d&&d.call(this,this.data[b]):a.io("/mainapi/albuminfo",{method:"GET",data:{id:b},on:{complete:function(b,f){var g;try{g=a.JSON.parse(f.responseText)}catch(h){}g?(g=e.parseData(g),d&&d.call(e,g||null)):(e.loading.setStyle("display","none"),e.showTip("抱歉，相册加载失败，请稍后再试~"),c("albumid",""),c("imageid",""))}}})},parseData:function(b){return a.Array.each(b.images,function(a,c){b.images[c].small="/images/"+b.images[c].small,b.images[c].large="/images/"+b.images[c].large}),b},bindAlbums:function(){var b=a.one("body");b.delegate("click",this.onAlbumClick,".album-cover a",this),b.delegate("click",this.onAlbumClick,".album-show a",this)},initLoading:function(){this.loading=a.Node.create('<div class="album-loading">正在加载相册...</div>'),a.one("body").prepend(this.loading)},onAlbumClick:function(a){a.halt(),this.showAlbum(a.currentTarget.ancestor("li").getAttribute("data-albumid"))},initTip:function(){this.tip=a.Node.create('<div class="album-tip"></div>'),a.one("body").prepend(this.tip)},showTip:function(a){var b=this;clearTimeout(this.tipTimer),this.tip.setContent(a),this.tip.setStyles({left:"50%",top:"50%",marginLeft:-this.tip.get("offsetWidth")/2+"px",visibility:"visible"}),this.tipTimer=setTimeout(function(){b.hideTip()},3e3)},hideTip:function(){clearTimeout(this.tipTimer),this.tip.setContent(""),this.tip.setStyles({left:"-200%",top:"-200%",visibility:"hidden"})}},a.Gallery.init()},"0.0.1",{requires:["galleria","io","json-parse"]});